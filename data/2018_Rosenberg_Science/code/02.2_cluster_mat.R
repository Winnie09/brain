source('/home-4/whou10@jhu.edu/scratch/Wenpin/brain/resource/01_function.R')
source('/home-4/whou10@jhu.edu/scratch/Wenpin/resource/function.R')
library(ClusterR)
print('loading data...')
mat <-  log2TPM_from_fludigm_count(readRDS('/home-4/whou10@jhu.edu/scratch/Wenpin/brain/data/allen/data/proc/count.rds')) 
print('clustering...')
pr = PCA(mat)
clu = KMeans_rcpp(data = pr,clusters=1e4)$clusters
names(clu) = colnames(mat)
dir.create('/home-4/whou10@jhu.edu/scratch/Wenpin/brain/data/allen/data/cluster_mat/ClusterR/', recursive = T)
saveRDS(clu, '/home-4/whou10@jhu.edu/scratch/Wenpin/brain/data/allen/data/cluster_mat/ClusterR/clu.rds')

print('calculating cluster mean...')
data = sapply(1:max(clu), function(c) rowMeans(mat[,names(clu[clu==c]),drop=F]) )
colnames(data) = paste0('clu',1:max(clu))
saveRDS(data, '/home-4/whou10@jhu.edu/scratch/Wenpin/brain/data/allen/data/cluster_mat/ClusterR/cluster_mat.rds')
